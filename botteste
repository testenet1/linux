#!/bin/bash

clear
#--------@LSVPN-----------#
source ShellBot2.sh
ShellBot.init --token "5361713081:AAHt7V0qVDso6Yf0-wCgJK76ZqQ7DvJJ9x8" --monitor --flush
ShellBot.username

# - Funcao menu
menu() {
    local msg
        msg="=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=\n"
        msg+="<b>ü§ñ OLA SEJA BEM VINDO(a) ü§ñ</b>\n"
        msg+="=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=\n\n"
        msg+="Gere seu teste agora mesmo!"
	local keyboard1
    	keyboard1="$(ShellBot.InlineKeyboardMarkup -b 'botao1')"
        ShellBot.sendMessage --chat_id ${message_chat_id[$id]} \
        --text "$(echo -e $msg)" \
        --reply_markup "$keyboard1" \
        --parse_mode html
        return 0
}

# - funcao criar ssh
criarteste() {
    if grep -q ${callback_query_from_id} lista; then
        created_date=$(grep -w ${callback_query_from_id} lista | cut -d ' ' -f 2)
        current_date=$(date +%s)
        if (( current_date - created_date > 3 * 24 * 60 * 60 )); then
            sed -i "/${callback_query_from_id}/d" lista
        else
            ShellBot.sendMessage --chat_id ${callback_query_message_chat_id} \
                --text "üö´ Voc√™ j√° gerou um SSH recentemente. ‚åõÔ∏è Aguarde 3 dias para gerar um novo teste!"
            return 0
        fi
    fi

    if ! grep -q ${callback_query_from_id} lista; then
        echo "${callback_query_from_id} $(date +%s)" >> lista

        usuario=$(echo teste$(( RANDOM % 99999 )))
        senha=$(( RANDOM % 99999 ))
        limite='1'
        tempo='1'
        tuserdate=$(date '+%C%y/%m/%d' -d " +1 days")
        useradd -M -N -s /bin/false $usuario -e $tuserdate > /dev/null 2>&1
        (echo "$senha"; echo "$senha") | passwd $usuario > /dev/null 2>&1
        echo "$senha" > /etc/SSHPlus/senha/$usuario
        echo "$usuario $limite" >> /root/usuarios.db
        echo "#!/bin/bash
pkill -f "$usuario"
userdel --force $usuario
grep -v ^$usuario[[:space:]] /root/usuarios.db > /tmp/ph ; cat /tmp/ph > /root/usuarios.db
rm /etc/SSHPlus/senha/$usuario > /dev/null 2>&1
rm -rf /etc/SSHPlus/userteste/$usuario.sh" > /etc/SSHPlus/userteste/$usuario.sh
        chmod +x /etc/SSHPlus/userteste/$usuario.sh
        at -f /etc/SSHPlus/userteste/$usuario.sh now + $tempo hour > /dev/null 2>&1
        echo ${callback_query_from_id} >> lista

        # - ENVIA O SSH
        ShellBot.sendMessage --chat_id ${callback_query_message_chat_id} \
            --text "$(echo -e "‚úÖ <b>Criado com sucesso</b> ‚úÖ\n\nSERVIDOR: TESTE\nUSUARIO: <code>$usuario</code>\nSENHA: <code>$senha</code>\n\n‚è≥ Expira em: $tempo Horas")" \
            --parse_mode html
        return 0
    fi
}

compraracesso() {
	local msg
	msg="=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=\n"
	msg+="<b> üí≤ OLA SEJA BEM VINDO AO MENU DE COMPRA!(a)üí≤ </b>\n"
	msg+="=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=\n"
	msg+="Ol√° *${callback_query_from_username[$id]}* , seja bem vindo ao menu de pagamento!\n"
	msg+="Escolha seu Plano:\n"
	msg+="<b>PLANOS ANDROID<b>\n"
	msg+="LS ANDROID MENSAL = R$19.99\n"
	msg+="LS ANDROID MENSAL PREMIUM = R$24.99\n"
	msg+="LS ANDROID MENSAL PLUS = R$34.99\n"
	msg+="LS ANDROID MENSAL PLUS PREMIUM = R$39.99\n"
	msg+="=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=\n"
	msg+="<b>PLANOS IOS<b>\n"
	msg+="LS IOS MENSAL = R$24.99\n"
	msg+="LS IOS MENSAL PREMIUM = R$29.99\n"
	msg+="=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=√ó=\n"
	msg+="Pague com a chave PIX:\n"
	msg+="testenetssh@gmail.com\n"
	msg+="Envie o comprOvante para"
	
	local keyboard1
    	keyboard1="$(ShellBot.InlineKeyboardMarkup -b 'botao1')"
	
	# Envia mensagem
	ShellBot.sendMessage --chat_id ${callback_query_message_chat_id[$id]} \
							--text "$(echo -e $msg)" \
							--reply_markup "$keyboard1" \
							--parse_mode html
		
							
	# retorno
	return 0
}


#enviar app
enviarapp() {
    ShellBot.answerCallbackQuery --callback_query_id ${callback_query_id[$id]} \
        --text "‚ôªÔ∏è ENVIANDO APLICATIVO, AGUARDE..."
    ShellBot.sendDocument --chat_id ${callback_query_message_chat_id} \
        --document "/etc/app/LSVPN1054apk" \
    return 0
}

#informacoes usuario
infouser () {
	ShellBot.sendMessage --chat_id ${message_chat_id[$id]} \
	--text "$(echo -e "Nome:  ${message_from_first_name[$(ShellBot.ListUpdates)]}\nUser: @${message_from_username[$(ShellBot.ListUpdates)]:-null}")\nID: ${message_from_id[$(ShellBot.ListUpdates)]} " \
	--parse_mode html
	return 0
}

unset botao1
botao1=''
ShellBot.InlineKeyboardButton --button 'botao1' --line 1 --text '‚ôªÔ∏èGERAR TESTE‚ôªÔ∏è' --callback_data 'gerarssh'
ShellBot.InlineKeyboardButton --button 'botao1' --line 2 --text 'üî∞BAIXAR APLICATIVOüî∞' --callback_data '2' --url 'http://bit.ly/LSVPN1054apk'
ShellBot.InlineKeyboardButton --button 'botao1' --line 3 --text 'üí≤COMPRAR ACESSOüí≤' --callback_data 'compra'
ShellBot.regHandleFunction --function criarteste --callback_data gerarssh
ShellBot.regHandleFunction --function compraracesso --callback_data compra

unset keyboard1
keyboard1="$(ShellBot.InlineKeyboardMarkup -b 'botao1')"
while :; do
   [[ "$(date +%d)" != "$(cat RESET)" ]] && {
   	echo $(date +%d) > RESET
   	echo ' ' > lista2
   }
  ShellBot.getUpdates --limit 100 --offset $(ShellBot.OffsetNext) --timeout 30
  for id in $(ShellBot.ListUpdates); do
    (
      ShellBot.watchHandle --callback_data ${callback_query_data[$id]}
      comando=(${message_text[$id]})
      [[ "${comando[0]}" = "/menu"  || "${comando[0]}" = "/start" ]] && menu
      [[ "${comando[0]}" = "/id"  ]] && infouser
      [[ ${comando[0]}" = "/compra"  ]] && compraracesso
    ) &
  done
done
